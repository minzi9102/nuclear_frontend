# 患者管理系统：搜索与高级搜索开发总结

## 一、核心功能实现

在这一系列的开发中，我们构建了一个具备准生产级交互体验的搜索体系：

- **标准化 UI 布局**：统一使用 Element Plus 的 `size="large"`（40px 高度）确保搜索框、搜索按钮、高级搜索按钮及新建按钮在视觉上高度对齐。

- **多字段模糊搜索**：利用 Strapi v5 的 `$or` 运算符和 `$containsi`（不区分大小写）逻辑，实现了通过姓名或其他关键词进行主动查询的能力。

- **多维度高级搜索**：
  - 性别筛选：通过 `el-radio-group` 进行精确匹配。
  - 出生日期区间：使用 `$gte`（大于等于）和 `$lte`（小于等于）实现日期范围检索。
  - 既往治疗经历：针对 JSON 数组字段，利用 `$contains` 实现多选组合搜索。

- **移动端优先适配**：弃用传统的 `el-table`，改用响应式栅格卡片布局（`el-row`/`el-col`），并实现在手机端通过 `el-drawer` 唤起高级搜索界面。

## 二、遇到的问题与解决方法 (Troubleshooting)

在整个开发流程中，我们攻克了多个技术难点，主要集中在 Strapi v5 适配、TypeScript 类型安全 和 UI 交互 三个方面。

### 1. Strapi v5 接口与数据对接

| 问题现象 | 根本原因 | 解决方法 |
|---------|---------|---------|
| 分页接口报错 (400) | Strapi v5 强制分页参数必须包裹在 `pagination` 对象中。 | 将参数重构为 `pagination: { page, pageSize }`。 |
| CRUD 操作失败 / 404 | v5 强制使用字符串格式的 `documentId`，而非旧版的整数 `id`。 | 全局改用 `documentId` 作为操作主键。 |
| 列表显示为空 (解包错误) | Strapi v5 响应结构存在双重数据包裹（Axios 的 `data` 和 Strapi 的 `data`）。 | 实现防御性双重解包逻辑：`res.data.data`。 |
| 修改数据报错 (400) | 提交 Payload 污染：包含了系统保留字段如 `documentId` 或 `createdAt`。 | 在 API 层使用解构赋值剔除这些非属性字段后再发送。 |

### 2. 前端组件逻辑与 UI 交互

| 问题现象 | 根本原因 | 解决方法 |
|---------|---------|---------|
| 搜索框/按钮高度不一 | 组件未显式设置 `size`，导致不同浏览器渲染默认高度差异。 | 统一在 Template 中设置 `size="large"` 并通过 Flex 布局对齐。 |
| 手机端菜单挤压内容 | CSS 媒体查询类名不匹配，导致侧边栏在小屏下未隐藏。 | 修正 CSS 选择器，在 768px 以下强制隐藏侧边栏并改用抽屉导航。 |
| "无"选项互斥失效 | 医学表单中"无"与其他治疗项在数据逻辑上是排他的。 | 利用 Vue 的 `watch` 深度监听实现逻辑互斥（勾选"无"则清空其他，反之亦然）。 |
| 弹窗状态残留 | `el-dialog` 默认仅隐藏 DOM，导致再次打开时保留上次的搜索或录入状态。 | 为弹窗添加 `destroy-on-close` 属性，强制关闭时销毁实例。 |

### 3. TypeScript 与工程化

| 问题现象 | 根本原因 | 解决方法 |
|---------|---------|---------|
| TS 报错 ts(2307)/找不到模块 | VS Code 的 TS Server 缓存不同步或导入语法不规范。 | 区分"仅类型导入"（`import type`）并重启 TS Server。 |
| 对象可能为 undefined | 嵌套数据访问（如 `patient.treatments[0]`）存在空指针风险。 | 使用可选链操作符 `?.` 和空值合并 `??`。 |
| 后端映射不一致 | 治疗部位等枚举值在多处硬编码，维护成本高。 | 建立单一事实来源（SSOT），使用 `constants` + `keyof typeof` 实现类型推导。 |

## 三、核心经验总结

- **规范优于实现**：通过 `src/constants/` 统一管理翻译表和选项，配合 TS 的动态推导，极大提升了重构时的健壮性。

- **防御性编程**：在处理 Strapi 响应和复杂的 `watch` 逻辑时，始终考虑到各种边界情况（如数据未定义、数组为空），避免运行时错误。

- **环境隔离**：意识到 localhost 与局域网 IP 的区别，通过环境变量（`.env`）管理 API 地址，确保了移动端真机调试的顺畅。
