# **📝 前端开发实战记录 - Phase 3.1：患者列表对接**

日期：2025-12-01

任务目标：实现患者数据的获取（Read）、列表展示、分页及搜索功能，打通 Vue 前端与 Strapi 后端的 API 通信。

---

## **1. 🏗️ 核心实现步骤 (Implementation)**

### **1.1 定义 TypeScript 类型 (src/api/types.ts)**

为了规范数据流，我们根据 Strapi v5 的文档定义了接口类型。

**特点**：Strapi v5 的响应结构变平了，不再像 v4 那样包裹在 attributes 里。

**定义**：
* `Patient`：实体结构（患者基本信息）
* `ApiResponse<T>`：通用响应壳（包含 data 和 meta）
* `PatientQueryParams`：查询参数（分页、过滤、排序）

### **1.2 封装 API 请求 (src/api/patient.ts)**

将 HTTP 请求逻辑与 UI 分离。

**对接接口**：GET /patients

**关键参数**：
* `pagination[page]`：当前页码
* `pagination[pageSize]`：每页数量
* `filters`：过滤条件
* `sort`：排序字段

### **1.3 构建列表页面 (src/views/patients/index.vue)**

**UI 组件**：
* 使用 `<el-card>` 布局，`<el-table>` 展示数据，`<el-pagination>` 处理分页。

**交互逻辑**：

* **fetchData()**：核心函数，负责调接口、解包数据。
* **搜索**：监听输入框，修改 filters 参数并重置页码。
* **删除**：预留了 `deletePatient` 调用逻辑（UI 已实现）。

### **1.4 路由配置 (src/router/index.ts)**

* 在 Layout 的 `children` 下新增 `path: 'patients'`。
* 将登录后的默认重定向从 `/home` 改为 `/patients`，方便调试。

---

## **2. 🐛 遇到的问题与解决方案 (Troubleshooting)**

这是本阶段最有价值的经验总结。

### **🔴 问题一："洋葱皮"数据解包错误**

**现象**：

* 页面加载图标一直转圈，控制台报错：`TypeError: can't access property "pagination", res.meta is undefined`。
* Vue 警告：`Invalid prop: Expected Array, got Object`。

**原因**：

* **认知偏差**：我们以为 `res` 就是数据数组。
* **事实真相**：`res` 是 Axios 的完整响应对象。
  * 第一层 `res.data`：是 HTTP 响应体（包含 Strapi 的 data 和 meta）。
  * 第二层 `res.data.data`：才是真正的患者列表数组。
  * 第二层 `res.data.meta`：才是分页信息。

**✅ 解决方案**：在 `fetchData` 中多剥一层"洋葱"：

````typescript
// ❌ 错误写法
// tableData.value = res.data

// ✅ 正确写法 (防御性编程)
if (res.data) {
    tableData.value = res.data.data || [] 
    total.value = res.data.meta?.pagination?.total || 0
}
````

---

### **🔴 问题二：TypeScript 类型定义冲突**

**现象**：

* IDE 爆红：类型"Patient[]"上不存在属性"data"。

**原因**：

* 我们在 `src/api/patient.ts` 里告诉 TS 这个接口返回的是 `ApiResponse<Patient>`（我们定义的结构）。
* 但实际代码中，`request.ts` 的拦截器可能没有处理这一层，导致 TS 认为 `res` 已经是数据了，但实际运行时它还是 Axios 对象。
* 编译器定义与运行时结构打架了。

**✅ 解决方案**：暂时使用 `any` 类型断言，告诉 TS "按我说的做，别管类型检查"：

````typescript
// 强制断言 res 为 any，以此访问 .data 属性
const res: any = await getPatientList(apiParams as any)
````

---

## **3. 💡 关键经验 (Key Takeaways)**

* **调试大法**：当数据出不来时，第一时间在 `fetchData` 里 `console.log(res)`，看控制台打印的真实 JSON 结构，永远不要盲目相信文档或记忆。

* **Strapi 结构**：Strapi 的标准返回通常是 `{ data: [...], meta: {...} }`，前端需要根据 Axios 拦截器的配置决定剥离几层。

* **API 权限**：永远记得在 Strapi 后台 **Settings -> Roles -> Public/Authenticated** 中勾选对应的 API 权限，并点击 Save。

---

## **🚀 下一步计划 (Next Step)**

现在列表页已经能够显示，接下来的任务是实现 "增"和"改"：

* **目标**：点击"新建患者"弹出一个对话框（Dialog）。
* **内容**：包含姓名、性别、生日的表单。
* **接口**：对接 POST /patients 和 PUT /patients/:id。

准备好继续了吗？我们可以开始写弹窗组件了！
