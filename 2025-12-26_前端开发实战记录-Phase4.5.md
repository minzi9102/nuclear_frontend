# 开发记录 - Phase 4.5

## 一、 开发过程回顾

### 1. 后端模型构建 (Strapi v5)

- **字段定义**：在 Patient 集合类型中新增了名为 past_treatments 的字段。

- **类型选择**：由于 Strapi 原生枚举 (Enumeration) 仅支持单选，因此选用了 JSON 类型来存储字符串数组（如 ['surgery', 'laser']）。

### 2. 前端标准化管理 (Constants & Types)

- **常量池建设**：在 src/constants/treatment.ts 中建立了 PAST_TREATMENT_MAP（翻译映射）和 PAST_TREATMENT_OPTIONS（供 UI 使用的选项数组）。

- **类型推导**：通过 TypeScript 的 keyof typeof 动态推导 PastTreatment 类型，确保前后端字段值的一致性。

- **接口更新**：在 src/api/types.ts 的 Patient 接口中加入了 past_treatments 属性。

### 3. 业务逻辑与 UI 实现

- **表单初始化**：在 formData 中将 past_treatments 默认值设为 ['none']（即"无"）。

- **交互逻辑**：使用 Element Plus 的 el-checkbox-group 实现多选，并通过 watch 监听器实现了"无"选项与其他治疗选项的互斥逻辑。

- **数据展示**：在患者卡片上，利用映射表将后端返回的英文 Key 实时转换为中文标签显示。

## 二、 遇到的问题与解决方法 (Troubleshooting)

在开发过程中，我们通过三轮调试解决了 TypeScript 类型安全和 Strapi v5 接口规范的问题：

| 问题分类 | 现象描述 / 报错信息 | 根本原因 | 解决方法 |
|---------|-------------------|---------|---------|
| TS 引用错误 | ts(2552): 找不到名称 "PastTreatment" | 在目标文件中未显式导入在常量文件中定义的类型。 | 在 types.ts 或组件中使用 `import type { PastTreatment }` 进行导入。 |
| 模板变量丢失 | ts-plugin(2339): 类型上不存在属性 "form" / "PAST_TREATMENT_OPTIONS" | 变量未在 `<script setup>` 顶层定义，或未正确导入到组件中。 | 确保所有在 Template 中使用的变量都在 Setup 中定义并 export，或检查是否误写在了嵌套对象内。 |
| 接口调用失败 | 400 Bad Request (修改患者数据时报错) | 字段污染：发送的请求载荷 data 对象中包含了系统保留字段 documentId。 | 数据清洗：在 API 层（patient.ts）使用解构赋值剔除 documentId、id 及 treatments 等非属性字段。 |

## 三、 核心经验总结

1. **Strapi v5 写入规范**：执行 PUT 或 POST 操作时，传递给 data 对象的必须纯粹是 schema.json 中定义的 attributes。任何如 documentId 或 createdAt 的系统字段都会导致校验失败。

2. **单一事实来源 (SSOT)**：通过在 constants 中统一定义翻译表，不仅解决了多语言显示问题，还通过类型推导保障了代码在重构时的健壮性。

3. **互斥逻辑处理**：在医学表单中，利用 Vue 的 watch 深度监听可以优雅地处理"无"与其他选项的逻辑排他性，提升数据录入的准确度。
