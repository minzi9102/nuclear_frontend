# 📝 前端开发实战记录 - Phase 3：治疗记录管理 (Treatment)

**日期：** 2025年12月12日

**目标：** 实现治疗记录的增删改查，建立患者与治疗记录的一对多关联，并实现后端自动生成治疗序号。

**技术栈：** Vue 3 (Frontend) + Strapi v5 (Backend)

---

## 1. 🏗️ 后端构建 (Strapi v5)

由于早期开发环境的数据污染问题，本阶段首先执行了后端重建。

### 1.1 数据模型设计 (Schema)

**Collection Type: Treatment**

关键字段：

- **treatmentNo** (Short Text): 自动生成的编号（如"第1次"）。
- **sequence_number** (Integer): 用于计算的纯数字序号。
- **target** (Enumeration): 治疗部位。
- **Images** (Media): 图片（当前设为非必填）。
- **patient** (Relation): 关联到 Patient (Many-to-One)，设置为 Required (必填)。

### 1.2 核心业务逻辑：自动序号生成

利用 Strapi 的 Lifecycle Hooks (`beforeCreate`) 实现。

**文件路径:** `src/api/treatment/content-types/treatment/lifecycles.js`

**逻辑流程:**

1. 拦截创建请求，提取关联的 patient ID。
2. 兼容处理 Strapi 后台 (`connect/set` 数组) 和 API (`documentId` 字符串) 的不同数据格式。
3. 若获取到的是 Integer ID，先反查数据库获取 DocumentId。
4. 查询该患者名下 `sequence_number` 最大的记录（包含 Draft 状态）。
5. 计算 `nextSequence` 并格式化为 `treatmentNo` 写入数据库。

### 1.3 权限配置

在 Settings -> Roles -> Authenticated 中开放了 Treatment 的 `find`, `findOne`, `create`, `delete` 权限。

---

## 2. 💻 前端构建 (Vue 3)

### 2.1 API 封装 (src/api/treatment.ts)

- **查 (List):** 使用 `populate: 'patient'` 参数，确保返回数据中包含患者姓名。
- **删 (Delete):** 关键修正 —— 参数必须使用字符串类型的 `documentId`，而非整数 `id`。
- **增 (Create):** 提交数据结构需包裹在 `{ data: { ... } }` 中。

### 2.2 页面实现 (src/views/treatments/index.vue)

**列表页:**

- 使用 `el-table` 展示数据。
- 展示"关联患者"列（处理空值情况）。
- 搜索栏支持按 `treatmentNo` 模糊查询。

**新建弹窗:**

- 使用 `el-select` 的远程搜索 (remote method) 功能，调用 `getPatientList` 接口实时检索患者。
- 下拉框 `value` 绑定患者的 `documentId`。
- 表单提交后自动刷新列表，显示后端计算好的序号。

---

## 3. 🐛 踩坑与故障排除记录 (Troubleshooting Log)

这是本阶段最有价值的经验总结，针对 Strapi v5 的特性进行了大量适配。

### 🔴 问题一：ID 类型混淆导致删除失败

**现象：** 点击删除，弹出确认框后请求发送，但后端返回 404 或无反应，数据未删除。

**原因：** Strapi v5 的 REST API 默认强制使用字符串格式的 `documentId` 进行操作，而前端传了整数 `id`。

**✅ 解决：** 修改 API 定义和页面逻辑，将所有操作的主键从 `row.id` 改为 `row.documentId`。

### 🔴 问题二：自动编号逻辑报错 Invalid key sequenceNumber

**现象：** 创建记录时后端报错。

**原因：** 误以为 Strapi 会自动将字段转为驼峰命名，但 `schema.json` 中定义的是下划线 `sequence_number`。

**✅ 解决：** 查阅 Schema 文件，将代码中所有字段名统一修正为 `sequence_number`。

### 🔴 问题三：数据库查询报错 Undefined attribute level operator id

**现象：** 无法自动计算序号。

**原因：** 在 `lifecycles.js` 中，将包含对象的变量（如 `{ documentId: '...' }`）直接传给了查询过滤器，Strapi 无法解析。

**✅ 解决：** 增加数据提取逻辑，确保传给 `filters` 的是纯字符串或数字 ID。

### 🔴 问题四：自动编号失效 (提取不到 Patient ID)

**现象：** 日志提示"未找到关联 Patient"，跳过计算逻辑。

**原因：** Strapi 后台（Admin Panel）提交关联数据时，使用了 `{ connect: [...] }` 或 `{ set: [...] }` 结构，且对象中只包含 Integer id。

**✅ 解决：**

- 增强提取逻辑，同时兼容 `connect` 和 `set` 操作符。
- 增加"反查"步骤：如果提取到的是 Integer ID，先查 Patient 表换取 `documentId`，再进行后续操作。

### 🔴 问题五：Element Plus 警告 Invalid prop: type

**现象：** 浏览器控制台报 Vue Warn。

**原因：** `<el-tag>` 的 `type` 属性被赋值为空字符串 `""`。

**✅ 解决：** 修改三元表达式，将空字符串改为默认值 `'primary'`。

### 🔴 问题六：Postman / 前端 403 Forbidden

**现象：** 重建后端后，API 请求全部失败。

**原因：** 数据库重置，导致旧的 JWT Token 和用户失效。

**✅ 解决：**

- 在新后台创建新用户。
- 前端清除 LocalStorage 缓存。
- Postman 重新调用 Login 接口获取新 Token 并更新环境变量。

---

## 4. 💡 Strapi v5 核心经验

通过本次开发，我们确认了 Strapi v5 的几个关键最佳实践：

1. **DocumentId 优于 ID：** 在前端开发和 API 调用中，始终优先使用 `documentId`。
2. **Schema 为准：** 字段命名（驼峰还是下划线）永远以 `schema.json` 为准。
3. **防御性编程：** 在编写 Lifecycle Hooks 时，必须考虑到数据来源的多样性（API 调用 vs 后台界面操作），数据结构可能完全不同。

---

## 🚀 下一步计划

至此，核心的 CRUD 和关联业务已打通。接下来的 Phase 4 我们将攻克最后一个难点：

- **多图上传与展示：** 处理 `Images` 字段，实现前端上传图片到 Strapi，并在列表中预览。
