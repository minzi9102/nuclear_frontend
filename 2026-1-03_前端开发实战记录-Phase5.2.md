Dev Context Snapshot [2026/01/03 18:45]
1. 核心任务与状态

    当前目标: 完成治疗记录列表页 (Treatment List) 对“多病灶 (Multi-Lesion)”数据结构的 UI 适配 (PC/Mobile 双端)。

    当前状态: ✅ 已完成 (代码已应用)

    关键文件:

        src/views/treatments/index.vue: [重构] 实现了 PC 端折叠展开 (Expand) 与 移动端垂直堆叠 (Vertical Stack) 混合布局。

2. 本次会话变动 (Changelog)

    [重构] PC 端交互: 引入 el-table-column type="expand"，在展开行中以子列表形式展示每个病灶的独立图片组、备注及专属时长。

    [重构] 移动端交互: 弃用单行卡片，改用“垂直堆叠流 (Focus Stream)”。新数据 (details) 渲染为多行列表 (左图右文)，旧数据 (target) 回退为单行兼容模式。

    [UI] 视觉增强: 引入 EditPen, Picture 图标用于提示备注与空图片状态；新增 .lesion-gallery (网格布局) 与 .lesion-stack-item 样式。

    [逻辑] 数据兼容: 完善了 v-if/else 逻辑，确保 row.details (新) 与 row.target (旧) 在同一列表中无缝共存。

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 在移动端真机验证多病灶卡片在长列表下的滚动性能及点击穿透问题。

    TODO: 验证 el-table 的展开状态在分页切换或搜索时的保持/重置行为。

    RISK: 列表页图片加载量显著增加 (每个病灶多图)，需关注网络负载，必要时引入懒加载 (Lazy Load) 优化。

4. 环境与依赖上下文

    Tech Stack: Vue 3, TypeScript, Element Plus (Icons: EditPen, Picture, etc.)

    Data Model: Strapi v5 Component (lesion-record) nested in Treatment.

    Config: 依赖 VITE_API_URL 环境变量处理图片路径。

Dev Context Snapshot [2026/01/04 12:50]
1. 核心任务与状态

    当前目标: 实现科研级图片自动命名策略优化，增加“治疗序号”标记 (_seqX) 以适配 NAS 归档。

    当前状态: ✅ 已完成 (API 接入与前端逻辑修复完毕)。

    关键文件:

        src/api/treatment.ts: [新增] getLastSequenceNumber 接口。

        src/components/TreatmentCreateDialog.vue: [修改] 接入序号预判逻辑，修正 handleSubmit 作用域报错。

2. 本次会话变动 (Changelog)

    [API] 新增 getLastSequenceNumber(patientId): 查询最新单条记录 (sort: sequence_number:desc) 用于前端预判。

    [Logic] 序号优先级: formData.sequence_number (手动) > predictedNextSequence (API预判) > 1 (默认)。

    [Naming] 文件名格式更新: ${Date}_${Pinyin}_${Gender}_${DOB}_seq${Count}_${Target}。

    [Fix] 修复 ts-plugin(2304): 将 const finalCount 定义提升至 if (currentPatient) 块级作用域之外，解决 else 分支无法访问变量的问题。

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 在真机/联调环境中验证上传文件的最终命名是否符合预期 (如 20260104_LiSi_Male_19900101_seq5_Face.jpg)。

    RISK: 极低概率并发冲突（前端预判 vs 后端 Lifecycle 计算），但在单人操作场景下可忽略。

4. 环境与依赖上下文

    Tech Stack: Vue 3 (Composition API), TypeScript, Strapi v5, pinyin-pro.

    Config: 依赖 VITE_API_URL；文件命名完全由前端 submitAll(specificSuffix) 控制。

Dev Context Snapshot [2026/01/04 16:00]
1. 核心任务与状态

    当前目标: 优化治疗记录（Treatment）中多病灶（Lesions/Details）的时长管理与显示逻辑。

    当前状态: 已完成优化

    关键文件:

        src/components/PatientDetailDialog/TreatmentList.vue: 病人详情页的时间轴显示逻辑。

        src/components/TreatmentCreateDialog.vue: 新建治疗记录的表单逻辑。

        src/views/treatments/index.vue: 治疗记录主列表（PC/Mobile）显示逻辑。

2. 本次会话变动 (Changelog)

    [UI/UX] 治疗时长显示策略 (Detail & List View):

        逻辑变更：每个病灶独立显示时长。若 lesion.duration 存在，显示为黄色高亮（特殊时长）；若不存在，回退显示总时长 row.duration 并显示为灰色（继承时长）。

        实现：修改了 TreatmentList.vue (Collapse Item) 和 index.vue (Table Expand & Mobile Card)。

        样式：新增 .is-special CSS 类及 el-tag 的 type="warning" 状态。

    [Logic] 新建表单约束 (TreatmentCreateDialog.vue):

        约束：当病灶数量 === 1 时，禁用“特殊时长”输入框，强制使用基础时长。

        联动：删除病灶导致数量降为 1 时，自动重置剩余病灶的 duration 为 undefined。

    [Refactor] 文件命名规则:

        变更：baseFilePrefix 生成规则由 YYYYMMDD 升级为 YYYYMMDD_HHmmss，增加文件名唯一性。

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 验证 Strapi 后端 Model 设置，确保 details.duration 字段允许为空（Nullable），以支持前端的“继承”逻辑。

    Note: 移动端适配使用了 CSS Stack 布局，需注意在超小屏幕（<320px）下时长标签是否会挤压部位名称。

4. 环境与依赖上下文

    Tech Stack: Vue 3 (Composition API), TypeScript, Element Plus, Day.js, Strapi v5 (Backend).

    Global Config: TREATMENT_TARGET_MAP 用于部位枚举映射。