Dev Context Snapshot [2025/12/30 17:35]
1. 核心任务与状态

    当前目标: 实现科研级图片语义化重命名 (PinyinName_Gender_DOB_Date_Target) 以适配未来 NAS 归档。

    当前状态: 前端逻辑已完成 (已解决中文丢失问题)，待后端 NAS/MinIO 配置。

    关键文件:

        src/components/TreatmentCreateDialog.vue: 集成 pinyin-pro，实现双路（锁定/搜索）患者对象获取与文件名拼接。

        src/components/ImageUploader/index.vue: 修改 submitAll 接收 namingPrefix 参数。

        src/api/upload.ts: 修改 uploadFile 支持在 FormData 中传入自定义文件名。

2. 本次会话变动 (Changelog)

    [新增] 引入依赖 pinyin-pro，解决 Strapi 后端自动清洗中文文件名导致信息丢失的问题。

    [重构] 文件名生成策略：

        姓名: 中文 -> 拼音 (CamelCase, LiSi)。

        性别: 直接使用后端原始值 (male -> Male)，移除冗余翻译。

        格式: ${Pinyin}_${Gender}_${DOB}_${Date}_${Target}。

    [修复] TreatmentCreateDialog.vue 中 handleSubmit 逻辑：增加了 else 分支，确保在搜索模式下能通过 patientOptions 获取完整 currentPatient 对象。

    

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 下一阶段需部署 MinIO (Windows) + 配置 Strapi AWS-S3 Provider 以实现 NAS 存储落地。

    NOTE: 当前文件上传后，Strapi 仍会自动追加 Hash 后缀 (如 _a1b2c.jpg)，这是核心机制，不影响排序归档，已确认接受此行为。

4. 环境与依赖上下文

    Tech Stack: Vue 3, TypeScript, Strapi v5, Element Plus.

    Dependencies: pinyin-pro (新增), dayjs.

    Logic Context:

        上传组件 (ImageUploader) 必须在 submitAll 被调用时才真正上传。

        文件名重命名依赖前端预处理，而非后端插件扩展。

Dev Context Snapshot [2025/12/30 18:55]
1. 核心任务与状态

    当前目标: 修复患者详情弹窗 (PatientDetailDialog) 及新建治疗记录组件中的控制台警告与 Props 类型错误。

    当前状态: ✅ 已完成 (修复代码已应用)

    关键文件:

        src/components/PatientDetailDialog/index.vue: 修复 treatments prop 传递 undefined 问题。

        src/components/PatientDetailDialog/TreatmentList.vue: 修复 images prop 传递 null 问题。

        src/components/TreatmentCreateDialog.vue: 修复 User 图标组件未注册问题。

2. 本次会话变动 (Changelog)

    [修复] 组件解析错误: 在 TreatmentCreateDialog.vue 中导入 User 图标，解决 [Vue warn]: Failed to resolve component: User。

    [修复] Props 类型校验失败 (Treatments): 在 PatientDetailDialog/index.vue 中为 TreatmentList 组件增加空值兜底 :treatments="patientData.treatments || []"，解决异步加载时数据为 undefined 的报错。

    [修复] Props 类型校验失败 (Images): 在 TreatmentList.vue 中为 TreatmentImages 组件增加空值兜底 :images="treatment.Images || []"，解决 Strapi v5 空媒体字段返回 null 导致的 Expected Array, got Null 报错。



3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 在真机/移动端验证 PatientDetailDialog 拆分后的滚动行为（Auto-scroll）是否流畅。

    TODO: 推进 Phase 5.0 NAS 归档配置（MinIO + Strapi S3 Provider）。

    RISK: Strapi v5 API 响应结构层级较深 (data.data), 需持续关注 API 封装层 (src/api/patient.ts) 的解包逻辑稳定性。

4. 环境与依赖上下文

    Tech Stack: Vue 3, TypeScript, Element Plus, Strapi v5.

    Data Context: Strapi v5 的 Media 字段在无数据时返回 null 而非 []，前端必须做空值合并处理。