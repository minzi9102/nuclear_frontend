# Phase 4 开发全过程总结 (Summary)

## 1. 后端配置 (Strapi v5)

**权限开启**：在 Settings -> Users & Permissions -> Roles -> Public 中，勾选了 Upload 插件的 upload (上传) 和 destroy (删除) 权限。

**模型确认**：确认 Treatment 模型中存在 Images 字段（多媒体类型，多选）。

## 2. 前端基础设施 (API & Types)

**类型定义**：定义了 StrapiMedia 接口，包含 id, url, formats 等核心字段。

**API 封装**：编写 `src/api/upload.ts`。
- 使用 FormData 封装文件。
- 处理 Axios 响应类型问题，使用 `as StrapiMedia` 断言确保类型安全。
- 实现了 `uploadFile` 方法，返回上传后的文件对象。

## 3. 核心组件封装 (<ImageUploader />)

**自定义上传**：覆盖 Element Plus 默认行为，使用 `:http-request` 调用自定义 API。

**双向绑定**：实现了 `v-model` (即 `modelValue` 和 `update:modelValue`)，在父子组件间同步图片对象数组。

**回显处理**：自动拼接后端 Base URL (`http://localhost:1337`)，解决相对路径无法显示的问题。

**手动状态管理**：不依赖 Element Plus 的自动列表更新，而是手动维护 `fileList`，确保 Strapi 返回的完整对象（包含 ID）不丢失。

## 4. 业务集成 (TreatmentForm)

**表单集成**：在 `src/views/treatments/index.vue` 中引入组件。

**数据提交**：提取图片数组中的 id，组装成 ID 数组 (`[1, 2]`) 发送给后端。

**列表展示**：使用 `el-image` 和 `getThumbnailUrl` 工具函数，在表格中展示缩略图及大图预览。

**清理机制**：使用 `destroy-on-close` 确保弹窗关闭后组件销毁，避免状态残留。

---

## 🏆 核心问题与解决方案复盘 (Post-Mortem Analysis)

### 1. 后端与 API 协议 (Strapi v5)

| 现象 / 报错 | 根本原因 (Root Cause) | 解决方案 (Solution) |
|-----------|-------------------|-----------------|
| **400 Bad Request**<br/>`Invalid key images` | Strapi v5 的 REST API 写入时，强制要求 Payload 必须包裹在 `data` 对象层级内，不能直接放在根节点。 | **API 层修正**：<br/>`request.post('/treatments', { data: submitData })` |
| **列表显示有图，但新建记录无图**<br/>（后端没报错，但关联失败） | 字段名称大小写敏感。<br/>Strapi 文档显示 Schema Name 为 `Images` (大写)，而后端默认只接受准确的字段名。 | **统一字段名**：<br/>前端提交和查询时，统一使用 `Images` (大写)，与 API 文档保持严格一致。 |
| **上传多张图，后端只存了一张** | Strapi 后台的内容模型配置错误。 | **后台配置**：<br/>进入 Content-Type Builder -> Treatment -> Images，确保勾选 "Multiple media"。 |

### 2. 前端组件逻辑 (Vue 3 + Element Plus) —— 最难点

| 现象 / 报错 | 根本原因 (Root Cause) | 解决方案 (Solution) |
|-----------|-------------------|-----------------|
| **提交时 `Images` 为空数组 `[]`**<br/>（尽管已上传成功） | **引用丢失 (Reference Lost)**。<br/>Element Plus 的 `onChange` 钩子会返回全新的文件对象列表 (Proxy)，覆盖了我们在 `customUploadRequest` 中手动挂载了 `response` (含ID) 的旧对象。导致 ID 丢失。 | **引入"外部映射表" (Map Strategy)**：<br/>建立一个 `reactive(new Map())`，以 `uid` 为键，永久存储后端返回的数据。无论视图列表怎么变，同步时都去 Map 里查 ID。 |
| **前端只能上传一张图**<br/>（第二张会顶替第一张） | `<el-upload>` 组件默认行为是单文件覆盖模式。 | **开启多选**：<br/>在组件标签上添加 `multiple` 属性。 |
| **再次打开新建弹窗，显示旧图片** | `el-dialog` 默认只是 `v-show` (隐藏)，组件实例未销毁，保留了上次的 `fileList` 状态。 | **生命周期管理**：<br/>给 `<el-dialog>` 添加 `destroy-on-close` 属性，强制关闭即销毁。 |

### 3. TypeScript 类型问题

| 现象 / 报错 | 根本原因 (Root Cause) | 解决方案 (Solution) |
|-----------|-------------------|-----------------|
| **`undefined` 不能分配给 `StrapiMedia`** | API 函数在非数组路径下没有明确的返回值。 | **严谨的控制流**：<br/>使用 `throw Error` 覆盖所有异常路径，并使用 `as StrapiMedia` 断言。 |
| **`undefined` 不能分配给 `number`** | Element Plus 的 `UploadFile.uid` 类型定义包含 `undefined`，但 Map 的键必须是确定的类型。 | **类型断言/默认值**：<br/>使用 `file.uid ?? 0` 或 `file.uid as number` 确保类型安全。 |

---

## 🔧 踩坑与解决方案记录 (Troubleshooting Log)

这是最宝贵的经验财富，请仔细阅读：

| 问题分类 | 遇到的现象/报错 | 原因分析 | 解决方案 |
|---------|----------------|--------|--------|
| **TypeScript** | 不能将类型 `undefined` 分配给 `StrapiMedia` | API 函数在数组判断逻辑外没有明确返回值，TS 认为可能返回 undefined。 | 增加 `throw Error` 确保所有路径都有返回，并使用 `as StrapiMedia` 进行类型断言。 |
| **Element Plus** | 找不到名称 `UploadFiles` / `uid` 类型错误 | 1. Element Plus 导出类型名为 `UploadUserFile[]`。<br/>2. 组件要求 `uid` 为 `number`，但代码曾转为 `string`。 | 1. 修正类型引用。<br/>2. 保持 `uid` 与 Strapi 返回的 `id` (number) 一致，不进行转换。 |
| **Strapi API** | `ValidationError: Invalid key images` | Strapi v5 REST API 强制要求 payload 必须包裹在 `data: {}` 对象中，不能直接放在根节点。 | 修改 API 调用：`request.post('/treatments', { data: submitData })` |
| **Strapi API** | 列表能查到图，但新建记录关联不上图 | Strapi v5 字段大小写敏感。查询(Populate)时需要 Schema Name (Images)，写入时通常兼容小写驼峰。 | 1. 查询参数保持 `populate: ['Images']` (大写)。<br/>2. 提交 Payload 最终确认使用 `{ data: { ..., Images: [id] } }` 结构。 |
| **组件通信** | 上传成功但提交时 `Images` 为空数组 `[]` | Element Plus 的 `handleSuccess` 钩子返回的 `uploadFiles` 状态更新滞后，覆盖了我们手动挂载好 `response` 的文件列表。 | 核心修复：在 `customUploadRequest` 中手动更新 `fileList` 并触发 `emit`，不再信任 `handleSuccess` 的回调参数。 |
| **用户体验** | 再次打开新建弹窗，显示上一张图片 | `el-dialog` 默认仅隐藏 (`v-show`) DOM，组件实例未销毁，保留了上次的 `fileList` 状态。 | 给 `<el-dialog>` 添加 `destroy-on-close` 属性，强制关闭时销毁组件。 |

---

## 🌟 导师寄语 (Next Step)

你已经攻克了 Web 开发中最繁琐的"多文件上传与关联"难关。现在的系统不仅能增删改查文本，还能处理多媒体数据，且具备了良好的鲁棒性。

### 接下来的建议

虽然目前功能完美，但为了代码的长期维护性，你可以考虑在闲暇时做一个小优化：

- 将 `http://localhost:1337` 提取到环境变量 (`.env` 文件) 中，使用 `import.meta.env.VITE_API_URL` 调用，这样上线部署时就不需要改代码了。

**Phase 4 任务结束！** 
