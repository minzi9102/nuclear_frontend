Dev Context Snapshot [2026/01/04 18:45]
1. 核心任务与状态

    当前目标: 完成图片上传组件的性能/体验优化，以及详情页影像画廊的交互重构。

    当前状态: 已完成 (代码已应用，待真机验证)。

    关键文件:

        src/components/ImageUploader/index.vue: [重构] 引入队列串行处理、防抖逻辑、虚线框交互及列表顺序调整。

        src/components/PatientDetailDialog/TreatmentImages.vue: [重构] 弃用 Carousel，实现"主图+缩略图"布局、手势滑动及 CSS 推拉动画。

2. 本次会话变动 (Changelog)

    [重构] ImageUploader 性能优化:

        引入 pendingQueue + while 循环串行处理图片，配合 await sleep(50) 让出主线程，防止 UI 卡死。

        增加 debounceTimer (100ms) 解决批量选择时剩余数量显示跳变问题。

    [交互] ImageUploader UI:

        空状态改为虚线框 (Dashed Box)，绑定 @click 触发隐藏 input。

        缩略图列表中将 上传按钮 (+) 移至首位。

    [新增] TreatmentImages 画廊:

        实现自定义画廊：主图 (absolute 定位) + 底部缩略图流。

        集成 Touch 事件 (touchstart/touchend)，阈值 40px，支持左右滑动切换。

        实现 <Transition> 动画 (slide-left/slide-right)，根据索引变化方向动态切换过渡效果。

        优化导航按钮样式：深色半透明背景，贴边显示，减少遮挡。

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 在真机 (iPad/Mobile) 上进行极限压力测试（一次性上传 12-20 张图），验证队列逻辑是否有效避免崩溃。

    TODO: 验证 TreatmentImages 在 iOS Safari 上的滑动体验，确认 touch-action: pan-y 是否有效阻止页面滚动冲突。

    RISK: 低端设备在 Canvas 连续重绘时可能仍有发热或轻微卡顿，需监控 submitAll 时的内存波动。

4. 环境与依赖上下文

    Tech Stack: Vue 3 (Composition API), TypeScript, Element Plus, Compressor.js.

    Key Config:

        Upload Limit: 12 images (Hardcoded check).

        CSS: 使用了 v-deep 和 Vue 3 <Transition> 组件。

Dev Context Snapshot [2026/01/04 21:36]
1. 核心任务与状态

    当前目标: 实现治疗记录列表页面的“编辑”功能集成，并优化排序与UI对齐。

    当前状态: ✅ 已完成 / 已验证

    关键文件:

        src/views/treatments/index.vue: [新增 handleEdit 入口，修改 sort 为 updatedAt:desc，优化 PC/Mobile 操作列 UI]

        src/components/TreatmentCreateDialog.vue: [实现 open() 支持编辑模式回显，处理多病灶/图片/时长数据映射]

        src/components/PatientDetailDialog/index.vue: [修复 API populate 参数，确保深层 details 数据加载]

        src/components/ImageUploader/index.vue: [支持 initialFiles 回显，submitAll 兼容旧 ID 与新 Raw 文件混合提交]

2. 本次会话变动 (Changelog)

    [新增] 在治疗记录列表 (PC & Mobile) 集成编辑按钮，调用 TreatmentCreateDialog 进行数据回填。

    [修改] 将列表默认排序逻辑从 createdAt:desc 更改为 updatedAt:desc，确保最近修改置顶。

    [UI] 强制 PC 端表格操作列 align="center"，优化移动端底部按钮组布局。

    [TS] 修复了 duration 字段 null 无法赋值给 undefined 的类型兼容问题 (使用 ?? undefined)。

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 在真机环境进行全流程回归测试 (新建 -> 编辑 -> 删除图片 -> 新增图片 -> 保存)。

    RISK: 需关注 Strapi v5 深层 Populate 对列表加载性能的影响，若数据量大需考虑后端字段裁剪。

4. 环境与依赖上下文

    Tech Stack: Vue 3 (Composition API), TypeScript, Element Plus, Strapi v5.

    Data Model: Treatment -> details (Component, Repeatable) -> photos (Media).

    Config: 依赖 VITE_API_URL 处理图片路径拼接。

Dev Context Snapshot [2026/01/04 22:30]
1. 核心任务与状态

    当前目标: 优化 TreatmentCreateDialog 组件中多病灶模式下的“治疗时长”交互逻辑与状态清洗。

    当前状态: ✅ 已完成 (逻辑已修复，TS 类型已修正)。

    关键文件:

        src/components/TreatmentCreateDialog.vue: [重构删除逻辑、拆分 v-model、显式类型注解]

2. 本次会话变动 (Changelog)

    [修复] 状态清洗 (State Sanitation):

        修改 removeLesion 函数：当 lesions.length === 1 时，强制重置 lesions[0].duration = undefined，防止“特殊时长”在退回单病灶模式后残留。

        解决 ts-plugin(2532) 报错：增加 const survivor = ...; if (survivor) 防御性判断。

    [重构] 交互逻辑 (Inheritance UI):

        拆分 v-model 为 :model-value 和 @update:model-value。

        实现逻辑：未修改时显示 formData.base_duration (继承)，修改后写入 item.duration (覆盖)。

    [UI] 显隐控制:

        移除 v-if="length > 1"，改为 :disabled="length === 1"。实现单病灶时显示输入框但禁止修改（展示基础时长）。

    [修复] TS 类型:

        解决 Template 中 @update:model-value 参数的 ts-plugin(7006) (Implicit any) 报错，显式标注 (val: number | undefined)。

3. 挂起的任务与已知问题 (CRITICAL)

    TODO: 验证 CSS 类 .is-inherited 是否正确生效（使继承值的文字颜色变淡）。

    RISK: 需再次确认 Strapi 后端 Model (treatment.details component) 的 duration 字段已设置为 Nullable (允许为空)，否则 undefined 提交时可能被转为 0 或报错。

4. 环境与依赖上下文

    Tech Stack: Vue 3 (Composition API), TypeScript (Strict Mode), Element Plus (el-input-number).

    Data Context:

        formData.lesions: Array<{ duration?: number, ... }>

        formData.base_duration: number (Global fallback)