📝 开发实战记录：患者页面交互重构与移动端适配
一、 开发目标与过程回顾

本次开发的主要目标是将原本信息过载的"患者卡片"进行瘦身，并将详细的治疗历史转移至"详情弹窗"中，同时重点优化移动端的浏览体验（如图片滑动）。
1. 界面重构 (UI Refactoring)

    列表页瘦身：移除了卡片上复杂的"最新治疗"预览和操作按钮，仅保留患者基本信息（姓名、年龄、性别）和"既往病史"摘要，点击卡片即可打开详情。

    详情弹窗设计：

        采用了 "患者信息头 + 治疗时间轴" 的布局。

        使用 el-collapse（折叠面板）展示治疗历史，每条记录独立封装，解决了 Element Plus 默认样式"连体"的问题。

        提供了三种设计风格（清爽医疗、现代卡片、时间轴），最终选用了 现代卡片风 (Modern Card)。

2. 数据逻辑增强 (Data & API)

    按需加载：列表页仅加载基础信息，点击卡片后才触发 open(id) 方法，请求该患者完整的治疗记录与图片。

    API 改造：修改了 src/api/patient.ts，修复了硬编码 populate 导致组件传参无效的问题，实现了对 Images 字段的精准获取。

3. 移动端交互升级 (Mobile Interaction)

    手势滑动：摒弃了只能点击切换图片的交互，实现了 "左右滑动切图" 的原生级体验。

    引用隔离：解决了在 v-for 循环中，多个轮播图实例互相干扰的问题，实现了每条记录独立控制。

    预览优化：修复了点击第 N 张图却总是从第 1 张开始预览的问题。

二、 遇到的问题与解决方法 (Troubleshooting Log)

在本次开发中，我们攻克了以下 7 个关键技术难点：

| 问题分类 | 现象描述 (Symptom) | 根本原因 (Root Cause) | 解决方案 (Solution) |
|---------|------------------|-------------------|-----------------|
| API 数据 | 图片显示为空：详情弹窗展开后，图片区域空白，调试发现 Images 字段不存在。 | 1. Strapi v5 机制：默认不返回深层嵌套关系（孙子级数据）。2. API 拦截：src/api/patient.ts 中硬编码了 populate 参数，覆盖了组件传递的 Images 请求。 | 1. 修改 API 封装，优先使用组件传入的 populate 参数。2. 在组件中显式声明 populate: { treatments: { populate: 'Images' } }。 |
| 样式布局 | 折叠面板头部塌陷：治疗记录的日期和 Tag 被挤压或消失。 | Element Plus 的 header 默认 width: 100% 且 flex 布局未处理好剩余空间分配。 | 使用 CSS :deep() 穿透，给标题容器设置 flex: 1 和 min-width: 0，并强制 white-space: nowrap 防止日期换行。 |
| 交互逻辑 | 滑动控制错乱：滑动第 3 条记录的图片，结果第 1 条记录的图片被切换了。 | 使用了全局单一的 ref，导致所有轮播图都绑定到了同一个变量上。 | 1. 改用 carouselRefs 对象字典存储实例。2. 使用 :ref="(el) => setCarouselRef(el, index)" 动态绑定。3. 触摸结束时传入 index 精准控制目标实例。 |
| TypeScript | 对象可能未定义：e.touches[0].clientX 报错 Object is possibly undefined。 | TS 严格模式认为数组可能为空。 | 使用 非空断言符 (!)，如 e.touches[0]!.clientX，明确告诉编译器此处必有值。 |
| 手势冲突 | 滑动图片时页面乱滚：左右滑图片时，页面会跟着上下滚动，体验极差。 | 浏览器的默认滚动行为与我们的 JS 手势逻辑冲突。 | 在图片容器 .image-wrapper 上设置 CSS 属性 touch-action: none;，强制接管该区域的触摸事件。 |
| 预览体验 | 大图预览位置错误：已经在走马灯滑到了第 3 张，点开大图却显示第 1 张。 | el-image 的预览器默认索引 (initial-index) 为 0。 | 在 v-for 中获取 imgIndex，并绑定 :initial-index="imgIndex"，同步列表与预览器的位置。 |
| 环境依赖 | Vite 启动报错：Error: ENOENT... node_modules\qs\... | 误删文件或依赖安装不完整，导致 qs 库丢失。 | 停止服务，运行 npm install 重新补全依赖。 |

三、 核心代码片段存档

为了方便后续查阅，以下是本次最核心的移动端手势控制逻辑（解决了引用隔离和类型安全问题）：

```typescript
// 存储所有轮播图实例的字典
const carouselRefs = ref<Record<number, any>>({})

// 动态绑定 Ref
const setCarouselRef = (el: any, index: number | string) => {
  if (el) carouselRefs.value[Number(index)] = el
}

// 触摸结束处理 (精准控制)
const onTouchEnd = (e: TouchEvent, index: number | string) => {
  if (!e.changedTouches || e.changedTouches.length === 0) return

  const touchEndX = e.changedTouches[0]!.clientX
  // ... 计算 diffX ...

  // 判定为水平滑动
  if (Math.abs(diffX) > 50) {
    // 🎯 核心：通过 Index 找到特定的那个轮播图
    const targetCarousel = carouselRefs.value[Number(index)]
    if (targetCarousel) {
      diffX > 0 ? targetCarousel.next() : targetCarousel.prev()
    }
  }
}
```

四、 总结

现在的 患者档案模块 已经具备了非常高的完成度：

    视觉上：摆脱了"后台管理系统"的生硬感，拥有了专业的医疗 App 质感。

    体验上：解决了移动端最头疼的图片浏览和手势冲突问题。

    代码上：修复了 API 层的隐患，并完善了 TypeScript 类型定义。
