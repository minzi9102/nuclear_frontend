# 📂 开发实战记录：科研影像批量导出与 NAS 部署准备

**文档日期：** 2026-01-07  
**项目名称：** Hospital-CMS (治疗效果记录管理平台)  
**当前阶段：** Phase 5 - 影像归档功能开发 & 生产环境部署准备

---

## 1. 项目概况 (Project Context)

### 1.1 技术栈

- **Frontend:** Vue 3 + TypeScript + Vite + Element Plus
- **Backend:** Strapi v5 (Node.js)
- **Database:** SQLite (当前), 生产环境可能迁移或保持。
- **Storage:**
  - Dev: 本地磁盘存储 (public/uploads)
  - Prod: NAS 私有云存储 (Infortrend NAS + Docker MinIO)

### 1.2 核心业务对象

系统核心围绕 **治疗记录 (Treatment)** 展开，数据结构经历了从"单部位"到"多病灶组件"的升级。

**Treatment (Collection):**
- `patient`: 关联患者
- `treatmentNo`: 字符串 (如 "第1次")
- `createdAt`: 创建时间 (用于生成文件夹日期的唯一来源)
- `target`: [旧数据] 枚举 (部位)
- `Images`: [旧数据] 媒体文件
- `details`: [新数据] Component (Repeatable)，包含 `part` (部位) 和 `photos` (媒体)。

---

## 2. 新增功能规格：科研影像批量导出 (Batch Export)

### 2.1 需求目标

支持医生在 治疗记录列表 页，通过多维度筛选（患者、部位、时间），将命中的影像数据流式打包下载，用于科研归档。

### 2.2 交付物标准

下载为 `.zip` 包，解压后目录结构严格标准化：

```
📁 Export.zip
├── 📁 张三_P2025001               <-- 层级1: 患者 (聚合)
│   ├── 📁 20250101_第1次_面部     <-- 层级2: {Date}_{Seq}_{Part}
│   │   ├── 📄 20250101_张三_面部_01.jpg
│   │   └── ...
│   └── 📁 20250101_第1次_颈部     <-- 同次治疗多部位自动分文件夹
└── ...
```

### 2.3 关键逻辑决策

- **日期来源：** 统一截取系统字段 `createdAt` (YYYYMMDD)。

- **数据混合策略 (Strategy B - Priority Mode)：**
  - 优先：若 `details` 组件有数据，仅导出 `details` 中的内容。
  - 回退：若 `details` 为空，回退导出根节点的 `target` 和 `Images`（兼容旧数据）。

- **文件名规范：** 系统自动重命名，格式为 `{Date}_{PinyinName}_{Part}_{Seq}.ext`。

---

## 3. 技术架构方案 (Technical Architecture)

为了解决大文件导出（GB级）可能导致的 OOM（内存溢出）问题，采用 **后端流式处理** 方案。

### 3.1 后端引擎 (Strapi v5)

- **核心库：** archiver (Zip流), pinyin-pro (中文转拼音), axios (获取远程流).

- **管道设计：** ReadStream (File/Http) -> Archiver -> Response (ctx.body)。全程不生成临时文件，不占用服务器内存。

- **存储适配器 (Storage Adapter)：**
  - 封装 `file-stream.ts` 工具类。
  - 自动识别文件 URL：
    - 若为 `/uploads/...` -> 使用 `fs.createReadStream` (本地模式)。
    - 若为 `http://...` -> 使用 `axios` 流请求 (NAS 模式)。

### 3.2 前端交互 (Vue 3)

- **入口：** 治疗记录列表页顶部操作栏。
- **筛选：** 复用列表的 Query 参数（患者姓名、部位、日期范围）。
- **触发：** 使用 `window.open` 或 `iframe` 触发浏览器原生下载行为。

---

## 4. 基础设施与部署准备 (Infrastructure & Deployment)

当前开发环境为 Local 模式，但代码需为上线后的 NAS 环境做准备。

### 4.1 生产环境拓扑

- **应用服务器：** 运行 Strapi 后端 + Vue 前端静态资源 (Nginx/Node)。

- **文件服务器：** Infortrend NAS 设备。
  - 服务：Docker 容器运行 MinIO。
  - 挂载：NAS 共享文件夹挂载至 MinIO 容器数据卷。

### 4.2 环境变量配置 (.env)

```ini
# Strapi Config
HOST=0.0.0.0
PORT=1337

# NAS / MinIO Config (用于生产环境)
NAS_ENDPOINT=http://192.168.1.215:9090
NAS_BUCKET=hospital-cms-storage
NAS_ACCESS_KEY=******
NAS_SECRET_KEY=******
```

---

## 5. 待讨论的核心议题 (Next Step: Deployment Packaging)

**目标：** 将上述系统（前端 Dist、后端 Node 服务、NAS MinIO 配置）打包成一套易于在医院内网（离线/局域网）环境部署的方案。

**主要挑战：**

1. **容器化编排：** 如何编写 `docker-compose.yml` 来管理 Strapi + MinIO + (可选) Database？
2. **离线部署：** 医院内网无外网，如何处理 `npm install` 依赖和 Docker 镜像传输？
3. **网络互通：** 如何确保容器内的 Strapi 能正确访问宿主机/局域网内的 NAS MinIO 服务？

---

*记录人：项目开发团队 | 下阶段计划：部署包构建与集成测试*
